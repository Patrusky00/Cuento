
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>La Aventura Mágica — Versión Película</title>
  <meta name="description" content="Cuento interactivo tipo película, bilingüe ES/EN, con voz, juegos y villancico."/>
  <meta name="theme-color" content="#7e22ce"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --card-w: 980px;
      --scene-h: 420px;
      --radius: 30px;
      --shadow: 0 25px 70px rgba(0,0,0,.4);
    }
    body{
      font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #3b82f6 0%, transparent 60%), linear-gradient(135deg,#1e3c72 0%,#2a5298 50%,#7e22ce 100%);
      min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;color:#111827
    }
    .book-container{
      background:#fff;border-radius:var(--radius);max-width:var(--card-w);width:100%;
      padding:32px;box-shadow:var(--shadow);position:relative;overflow:hidden;animation:fadeIn .6s ease-in
    }
    @keyframes fadeIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
    .snow-top{position:absolute;left:0;right:0;top:0;height:28px;background:linear-gradient(180deg,#fff 0%,transparent 100%);border-radius:var(--radius) var(--radius) 0 0}
    .title{text-align:center;color:#dc2626;font-size:2.4em;margin:.2em 0 .1em;text-shadow:3px 3px 6px rgba(0,0,0,.2)}
    .subtitle{text-align:center;color:#15803d;font-size:1.1em;margin-bottom:8px;font-weight:700}
    .panel{display:flex;flex-direction:column;gap:10px;align-items:center;margin:10px 0 18px}
    .row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center}
    .audio-btn{
      background:linear-gradient(135deg,#15803d 0%,#16a34a 100%);color:#fff;border:none;
      padding:12px 20px;font-size:1.02em;border-radius:999px;cursor:pointer;font-weight:bold;
      display:inline-flex;align-items:center;gap:10px;transition:all .2s
    }
    .audio-btn:hover{transform:translateY(-1px) scale(1.03)}
    .toggle{background:linear-gradient(135deg,#475569 0%,#334155 100%)}
    select,input[type=checkbox]{accent-color:#7c3aed}
    .select,.preset{padding:10px 12px;border-radius:12px;border:2px solid #e5e7eb;font-size:.95em}
    label{font-weight:bold;color:#334155;font-size:.95em}

    .page-counter{text-align:center;font-size:1.08em;color:#7c3aed;margin:8px 0 12px;font-weight:800}

    /* ===== Escena tipo película ===== */
    .scene{
      height:var(--scene-h);border-radius:22px;position:relative;overflow:hidden;margin:12px 0;
      box-shadow:inset 0 0 60px rgba(0,0,0,.35);border:5px solid #fbbf24;background:#0b1d36
    }
    .scene .img-wrap{position:absolute;inset:0;overflow:hidden;transform-origin:center;animation:kenburns 14s ease-in-out infinite alternate}
    .scene img{position:absolute;inset:0;min-width:100%;min-height:100%;object-fit:cover;filter:contrast(1.05) saturate(1.05)}
    @keyframes kenburns{from{transform:scale(1.05)}to{transform:scale(1.12) translateY(-10px)}}
    .stars,.stars2{pointer-events:none;position:absolute;inset:0;background-repeat:repeat;opacity:.35}
    .stars{background-image: radial-gradient(2px 2px at 20% 30%,#fff,transparent), radial-gradient(2px 2px at 60% 70%,#fff,transparent), radial-gradient(2px 2px at 80% 20%,#fff,transparent);}
    .stars2{background-image: radial-gradient(1px 1px at 10% 80%,#fff,transparent), radial-gradient(1px 1px at 50% 40%,#fff,transparent), radial-gradient(1px 1px at 90% 60%,#fff,transparent);opacity:.25;animation: drift 40s linear infinite}
    @keyframes drift{from{transform:translateY(0)}to{transform:translateY(-120px)}}
    canvas.snow{position:absolute;inset:0;pointer-events:none}

    /* Fallback ilustrado si falta imagen */
    .fallback{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:110px}
    .float{animation:float 3.6s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .glow{filter:drop-shadow(0 0 14px rgba(255,255,255,.7))}

    .story-text{font-size:1.18em;line-height:1.85;color:#1f2937;margin:14px 0 6px;text-align:center;font-weight:500}
    .highlight{color:#dc2626;font-weight:800}
    .magic-word{color:#7c3aed;font-weight:800}

    .navigation{display:flex;gap:14px;margin-top:16px;justify-content:center}
    .nav-btn{
      padding:16px 28px;font-size:1.05em;font-weight:800;border:none;border-radius:16px;cursor:pointer;
      transition:all .25s;font-family:inherit;box-shadow:0 6px 12px rgba(0,0,0,.2);min-width:170px
    }
    .nav-btn.next{background:linear-gradient(135deg,#dc2626 0%,#ef4444 100%);color:#fff}
    .nav-btn.prev{background:linear-gradient(135deg,#0284c7 0%,#0ea5e9 100%);color:#fff}
    .nav-btn:hover:not(:disabled){transform:translateY(-3px) scale(1.03)}
    .nav-btn:disabled{opacity:.5;cursor:not-allowed}

    .choices{display:flex;flex-direction:column;gap:14px;margin-top:14px;max-width:600px;margin-inline:auto}
    .choice-btn{padding:18px;font-size:1.08em;font-weight:800;border:none;border-radius:16px;cursor:pointer;transition:all .25s;font-family:inherit;color:#fff}
    .choice-btn:nth-child(1){background:linear-gradient(135deg,#f59e0b 0%,#f97316 100%)}
    .choice-btn:nth-child(2){background:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    .choice-btn:hover{transform:translateY(-5px)}

    /* Juegos (igual que en tu versión anterior) */
    .village{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;max-width:680px;margin:8px auto}
    .tile{height:62px;border-radius:14px;border:2px dashed rgba(255,255,255,.6);display:flex;align-items:center;justify-content:center;font-size:30px;background:rgba(255,255,255,.2);cursor:pointer;transition:.15s}
    .tile.revealed{background:rgba(255,255,255,.88);border-style:solid}
    .counter-badge{width:56px;height:56px;border-radius:50%;background:#ef4444;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;margin:2px auto 0;box-shadow:0 6px 12px rgba(0,0,0,.2)}
    .progress{margin-top:6px;text-align:center;font-weight:800;color:#0f766e}
    .puzzle{display:grid;grid-template-columns:repeat(2,120px);gap:10px;justify-content:center;margin:6px auto}
    .piece{width:120px;height:120px;border-radius:14px;background:#fff;border:3px solid #fde68a;display:flex;align-items:center;justify-content:center;font-size:38px;cursor:pointer;transition:.15s}
    .piece.correct{background:#f0fdf4;border-color:#86efac}
    .puzzle-hint{font-size:.95em;color:#334155;text-align:center;margin-top:6px}
    .carol{margin:12px auto;padding:16px;border-radius:16px;border:3px solid #fbbf24;background:linear-gradient(180deg,#fff7ed 0%,#fffbeb 100%);max-width:760px}
    .carol h3{color:#b45309;text-align:center;margin-bottom:8px}
    .verses p{margin:8px 0;text-align:center;color:#4b5563}
    .carol .actions{display:flex;gap:10px;justify-content:center;margin-top:10px}
    .btn-outline{background:#fff;border:2px solid #ef4444;color:#ef4444}

    @media(max-width:700px){
      :root{ --scene-h: 320px; }
      .title{font-size:2em}
      .story-text{font-size:1.02em}
      .nav-btn{padding:14px 22px;font-size:1em;min-width:140px}
    }
  </style>
</head>
<body>
  <div class="book-container">
    <div class="snow-top"></div>
    <h1 class="title" id="title">🎄 La Aventura Mágica 🎄</h1>
    <h2 class="subtitle" id="subtitle">de <span class="highlight">Darek</span> y <span class="highlight">Conan</span></h2>

    <!-- Controles -->
    <div class="panel" id="controls"></div>

    <div class="page-counter" id="page-counter"></div>

    <!-- Escena “película” -->
    <div class="scene">
      <div class="img-wrap"><img id="scene-img" alt=""/></div>
      <div class="stars"></div><div class="stars2"></div>
      <canvas class="snow" id="snow"></canvas>
      <div class="fallback" id="fallback"></div>
    </div>

    <!-- Texto + juegos/navegación -->
    <div id="story-container"></div>
  </div>

  <script>
    /* ======= Estado y persistencia (compatible con tu versión) ======= */
    const S = {
      pg: Number(localStorage.getItem('pg') ?? 1),
      path: localStorage.getItem('path') || null,
      voiceOn: JSON.parse(localStorage.getItem('voiceEnabled') ?? 'true'),
      voiceURI: localStorage.getItem('voiceURI') || '',
      tone: localStorage.getItem('tone') || 'narrador',
      lang: localStorage.getItem('lang') || 'es-ES',
      autoNarrate: JSON.parse(localStorage.getItem('autoNarrate') ?? 'true'),
      autoAdvance: JSON.parse(localStorage.getItem('autoAdvance') ?? 'true'),
      gameA_done: JSON.parse(localStorage.getItem('gameA_done') ?? 'false'),
      gameB_done: JSON.parse(localStorage.getItem('gameB_done') ?? 'false')
    };
    function save(){ for(const k in S){ localStorage.setItem(k==='voiceOn'?'voiceEnabled':k, typeof S[k]==='string'?S[k]:JSON.stringify(S[k])); } }

    /* ======= Imágenes esperadas ======= */
    const IMG = {
      common:{1:'images/p1_home.jpg',2:'images/p2_tree.jpg',3:'images/p3_bark.jpg',4:'images/p4_hotwheels.jpg',5:'images/p5_car_fly.jpg',6:'images/p6_sky.jpg',7:'images/p7_santa_sad.jpg'},
      A:{8:'images/p8A_village.jpg',9:'images/p9A_bear.jpg',10:'images/p10A_cave_bells.jpg',11:'images/p11A_bells_magic.jpg',12:'images/p12A_reindeer.jpg',13:'images/p13A_santa_happy.jpg',14:'images/p14A_car_gift.jpg',15:'images/p15A_home_end.jpg'},
      B:{8:'images/p8B_workshop.jpg',9:'images/p9B_elves.jpg',10:'images/p10B_paint.jpg',11:'images/p11B_bells_music.jpg',12:'images/p12B_reindeer.jpg',13:'images/p13B_santa_praise.jpg',14:'images/p14B_color_car.jpg',15:'images/p15B_home_end.jpg'}
    };

    /* ======= Textos ampliados (ES/EN) ======= */
    const TEXT = { /* ——— idéntico al del mensaje anterior, abreviado aquí ——— */
      es: {
        title:"🎄 La Aventura Mágica 🎄", subtitle:"de <span class='highlight'>Darek</span> y <span class='highlight'>Conan</span>",
        ui:{listen:"🔊 Escuchar la página",narrating:"🔊 Narrando...",voiceOn:"🔈 Voz: ON",voiceOff:"🔇 Voz: OFF",test:"▶️ Probar voz",toneLabel:"Tono:",langLabel:"Idioma:",voiceLabel:"Voz:",autoNarrate:"Auto narrar",autoAdvance:"Auto avanzar",back:"Atrás",next:"Siguiente ➡️",restart:"Volver a empezar",searchBells:"Buscar los cascabeles perdidos",makeBells:"Hacer cascabeles nuevos",bellsFound:"Cascabeles encontrados",bellsDone:"¡Excelente! Has encontrado todos los cascabeles.",puzzleHint:"Toca las piezas en orden:",puzzleDone:"¡Puzzle completado! Continuemos.",carolBtn:"Escuchar villancico",alreadyBells:"Ya encontraste los cascabeles.",alreadyPuzzle:"Puzzle ya completado."},
        pages:{1:"Nochebuena. <span class='highlight'>Darek</span> (3 años) y <span class='highlight'>Conan</span> miran el cielo...",2:"El salón brilla...",3:"Conan ladra...",4:"Los Hot Wheels empiezan a <span class='magic-word'>brillar</span>...",5:"“¡Sube, piloto!”...",6:"Vuelan sobre nubes...",7:"En el Polo Norte..."},
        A:{8:"CAMINO A – Investigar el pueblo: encuentra <b>6 cascabeles</b> 🔔.",9:"Un osito polar...",10:"Cueva de hielo...",11:"“¡Tilín, tilín!”...",12:"Los renos sienten la melodía...",13:"Papá Noel abraza a Darek...",14:"Hot Wheels que reluce...",15:"Ya en casa..."},
        B:{8:"CAMINO B – Crear nuevos cascabeles en el taller.",9:"Duendes ayudan...",10:"Colores <span class='magic-word'>brillantes</span> y deseos...",11:"Música cálida...",12:"Renos vuelan...",13:"“¡Artista!”...",14:"Coche camaleón...",15:"Regresan a casa."},
        carolTitle:"🎵 Villancico de Darek y Conan",
        carolText:`En Nochebuena Darek soñó...`
      },
      en: {
        title:"🎄 The Magic Adventure 🎄", subtitle:"by <span class='highlight'>Darek</span> and <span class='highlight'>Conan</span>",
        ui:{listen:"🔊 Read this page",narrating:"🔊 Narrating...",voiceOn:"🔈 Voice: ON",voiceOff:"🔇 Voice: OFF",test:"▶️ Test voice",toneLabel:"Tone:",langLabel:"Language:",voiceLabel:"Voice:",autoNarrate:"Auto narrate",autoAdvance:"Auto advance",back:"Back",next:"Next ➡️",restart:"Restart",searchBells:"Search for the bells",makeBells:"Make new bells",bellsFound:"Bells found",bellsDone:"Great! You found all the bells.",puzzleHint:"Tap pieces in order:",puzzleDone:"Puzzle completed! Let's continue.",carolBtn:"Play carol",alreadyBells:"You already found the bells.",alreadyPuzzle:"Puzzle already completed."},
        pages:{1:"Christmas Eve. <span class='highlight'>Darek</span> (3) and <span class='highlight'>Conan</span>...",2:"The living room glows...",3:"Conan barks...",4:"Hot Wheels start to <span class='magic-word'>shine</span>...",5:"“Hop in, pilot!”...",6:"They fly above clouds...",7:"At the North Pole..."},
        A:{8:"PATH A – Investigate village: find <b>6 bells</b> 🔔.",9:"A little polar bear...",10:"Ice cave...",11:"“Ding, ding!”...",12:"Reindeer feel the melody...",13:"Santa hugs Darek...",14:"Glow-in-the-dark Hot Wheels...",15:"Back home..."},
        B:{8:"PATH B – Craft new bells at the workshop.",9:"Elves bring paints...",10:"<span class='magic-word'>Bright</span> colors and wishes...",11:"Warm magic music...",12:"Reindeer soar...",13:"“An artist!”...",14:"Color-changing car...",15:"They return home."},
        carolTitle:"🎵 Darek & Conan's Carol",
        carolText:`On Christmas Eve young Darek dreamed...`
      }
    };

    /* ======= Tono de voz ======= */
    const TONE={narrador:{rate:.96,pitch:1.02,volume:1,sampleES:"Había una vez...",sampleEN:"Once upon a time..."},aventurera:{rate:1.06,pitch:1.28,volume:1,sampleES:"¡Aventura!",sampleEN:"Adventure!"},papa_noel:{rate:.9,pitch:.9,volume:1,sampleES:"Ho, ho, ho!",sampleEN:"Ho, ho, ho!"},duende:{rate:1.18,pitch:1.5,volume:1,sampleES:"Tra-la-lá!",sampleEN:"Tra-la-la!"},conan:{rate:1.02,pitch:1.4,volume:1,sampleES:"Guau, guau",sampleEN:"Woof, woof"},villancico:{rate:.88,pitch:1.25,volume:1,sampleES:"Campanas suenan ya...",sampleEN:"Bells are ringing..."}};

    function L(){return S.lang.startsWith('en')?'en':'es';}
    function U(){return TEXT[L()].ui;}

    /* ======= Ilustraciones fallback ======= */
    function fallbackFor(pg, path){
      const c={1:"<span class='float glow'>🏠</span> <span class='float'>🌙✨</span>",2:"<span class='glow'>🎄</span> <span class='float'>💫🎁</span>",3:"<span class='float'>✨</span> <span>🐕</span> <span>💛</span>",4:"<span class='float glow'>🚗</span> <span>🏎️</span> <span>✨</span>",5:"<span class='float'>🏎️</span> <span>💨</span> <span>🐕</span>",6:"<span class='float'>🌈</span> <span>☁️</span> <span>✨</span>",7:"<span class='float'>🎅</span> <span>😢</span> <span>❄️</span>"};
      const A={8:"<span class='float'>🏘️</span> <span>🌲</span> <span>❄️</span>",9:"<span class='float'>🐻‍❄️</span> <span>🎵</span> <span>🔔</span>",10:"<span class='float'>🏔️</span> <span>✨</span> <span>🔔</span>",11:"<span class='glow'>🔔</span> <span>🎶</span> <span>💫</span>",12:"<span>🦌</span> <span>🔔</span> <span>✨</span>",13:"<span>🎅</span> <span>😊</span> <span>🎁</span>",14:"<span>🏎️</span> <span class='glow'>🌟</span> <span>💨</span>",15:"<span>🏠</span> <span>❤️</span> <span>✨</span>"};
      const B={8:"<span>🧩</span> <span>🎨</span> <span>✨</span>",9:"<span>🧝</span> <span>🎨</span> <span>💛</span>",10:"<span>✨</span> <span>🎨</span> <span>🔔</span>",11:"<span>💫</span> <span>🔔</span> <span>🎶</span>",12:"<span>🦌</span> <span>🔔</span> <span>✨</span>",13:"<span>🎅</span> <span>😊</span> <span>🎁</span>",14:"<span>🏎️</span> <span>🌟</span> <span>💨</span>",15:"<span>🏠</span> <span>❤️</span> <span>✨</span>"};
      if(pg<=7) return c[pg]||""; return (path==='A'?A:B)[pg]||"";
    }

    /* ======= Data por página ======= */
    function dataForPage(){
      if(S.pg<=7) return { text: TEXT[L()].pages[S.pg], hasChoice: S.pg===7, img: IMG.common[S.pg], className: ['','night','magic','magic','magic','night','morning','snow'][S.pg] || 'magic' };
      const set = (S.path==='A')?'A':'B';
      const clsA={8:"snow",9:"snow",10:"snow",11:"magic",12:"workshop",13:"workshop",14:"night",15:"magic"};
      const clsB={8:"workshop",9:"workshop",10:"magic",11:"magic",12:"workshop",13:"workshop",14:"night",15:"magic"};
      return { text: TEXT[L()][set][S.pg], isGame:S.pg===8, gameType:(S.pg===8 && set==='A')?'bells':(S.pg===8?'puzzle':null), isFinal:S.pg===15, img:(IMG[set]||{})[S.pg], className:(set==='A'?clsA:clsB)[S.pg] };
    }

    /* ======= Controles ======= */
    function renderControls(){
      const toneLabels = L()==='en'
        ? {narrador:"Warm narrator", aventurera:"Cheerful adventure", papa_noel:"Santa Claus", duende:"Mischievous elf", conan:"Conan (childlike)", villancico:"Carol (slow/high)"}
        : {narrador:"Narrador cálido", aventurera:"Aventurera alegre", papa_noel:"Papá Noel", duende:"Duende travieso", conan:"Conan (infantil)", villancico:"Villancico (lento/agudo)"};
      const tones = Object.entries(toneLabels).map(([v,l])=>`<option value="${v}">${l}</option>`).join('');
      const html = `
        <div class="row">
          <button id="btnListen" class="audio-btn">${U().listen}</button>
          <button id="btnToggle" class="audio-btn toggle">${S.voiceOn?U().voiceOn:U().voiceOff}</button>
          <button id="btnTest" class="audio-btn">${U().test}</button>
        </div>
        <div class="row">
          <label for="tone">${U().toneLabel}</label>
          <select id="tone" class="preset">${tones}</select>

          <label for="lang">${U().langLabel}</label>
          <select id="lang" class="select">
            <option value="es-ES">Español</option>
            <option value="en-US">English</option>
          </select>

          <label for="voice">${U().voiceLabel}</label>
          <select id="voice" class="select"><option value="">(Automática)</option></select>
        </div>
        <div class="row">
          <label for="autoNarrate">${U().autoNarrate}</label>
          <input id="autoNarrate" type="checkbox"/>
          <label for="autoAdvance">${U().autoAdvance}</label>
          <input id="autoAdvance" type="checkbox"/>
        </div>`;
      const panel=document.getElementById('controls'); panel.innerHTML=html;
      document.getElementById('tone').value=S.tone;
      document.getElementById('lang').value=S.lang;
      document.getElementById('autoNarrate').checked=S.autoNarrate;
      document.getElementById('autoAdvance').checked=S.autoAdvance;

      document.getElementById('btnListen').addEventListener('click', speakCurrentPage);
      document.getElementById('btnToggle').addEventListener('click', ()=>{ S.voiceOn=!S.voiceOn; save(); document.getElementById('btnToggle').textContent=S.voiceOn?U().voiceOn:U().voiceOff; if(!S.voiceOn) stopSpeech(); });
      document.getElementById('btnTest').addEventListener('click', ()=>{ if(!S.voiceOn) return alert(L()==='en'?'Turn voice ON to test.':'Activa la voz para probar.'); const sample = L()==='en'?TONE[S.tone].sampleEN:TONE[S.tone].sampleES; speakText(sample, S.tone); });
      document.getElementById('tone').addEventListener('change', e=>{ S.tone=e.target.value; save(); });
      document.getElementById('lang').addEventListener('change', e=>{ S.lang=e.target.value; S.voiceURI=''; save(); applyLanguage(); });
      document.getElementById('voice').addEventListener('change', e=>{ S.voiceURI=e.target.value; save(); });
      document.getElementById('autoNarrate').addEventListener('change', e=>{ S.autoNarrate=e.target.checked; save(); if(!S.autoNarrate) stopSpeech(); });
      document.getElementById('autoAdvance').addEventListener('change', e=>{ S.autoAdvance=e.target.checked; save(); });

      if('speechSynthesis' in window){ populateVoices(); window.speechSynthesis.onvoiceschanged = populateVoices; }
    }

  /* ======= Navegación, juegos y villancico ======= */
    function renderNav(){ return `<div class="navigation"><button class="nav-btn prev" onclick="prevPage()" ${S.pg===1?'disabled':''}>⬅️ ${U().back}</button><button class="nav-btn next" onclick="nextPage()">${S.pg===15?('🔄 '+U().restart):U().next}</button></div>`; }
    function renderCarol(){ return `<div class="carol"><h3>${TEXT[L()].carolTitle}</h3><div class="verses"><p>${TEXT[L()].carolText.replace(/\n/g,'</p><p>')}</p></div><div class="actions"><button class="audio-btn" onclick="playCarol()">🎶 ${U().carolBtn}</button><button class="audio-btn btn-outline" onclick="nextPage()">🔄 ${U().restart}</button></div></div>` + renderNav(); }
    function renderBells(){
      if(S.gameA_done){ return `<div class="progress">${U().alreadyBells}</div>` + renderNav(); }
      const items=['🏠','🎄','🌲','☃️','🧊','🦌','🎁','⛪','🎅','🏔️','⛸️','🧝','🏡','🚗','✨','❄️','🌟','🍭','⛄','🧭'];
      const total=20, need=6; const marks=new Set(); while(marks.size<need) marks.add(Math.floor(Math.random()*total));
      window.__bells__={found:0, marks:[...marks], need};
      let g=`<div class="counter-badge" id="bellCircle">0/${need}</div><div class="village">`;
      for(let i=0;i<total;i++) g+=`<div class="tile" data-i="${i}" onclick="clickBell(this)">${items[i%items.length]}</div>`;
      g+=`</div><div class="progress" id="bellProgress">${U().bellsFound}: 0 / ${need}</div><div class="navigation"><button class="nav-btn prev" onclick="prevPage()">⬅️ ${U().back}</button><button class="nav-btn next" id="bellNext" disabled>${U().next}</button></div>`;
      return g;
    }
    function clickBell(el){
      const s=window.__bells__; if(!s) return; const i=+el.dataset.i; if(el.classList.contains('revealed')) return;
      el.classList.add('revealed'); if(s.marks.includes(i)){ el.textContent='🔔'; s.found++; document.getElementById('bellProgress').textContent=`${U().bellsFound}: ${s.found} / ${s.need}`; document.getElementById('bellCircle').textContent = `${s.found}/${s.need}`; if(s.found>=s.need){ S.gameA_done=true; save(); const b=document.getElementById('bellNext'); b.disabled=false; b.onclick=()=>nextPage(); if(S.autoNarrate && S.voiceOn) speakText(U().bellsDone);} } else { el.style.transform='scale(0.95)'; setTimeout(()=>el.style.transform='',120); }
    }
    function renderPuzzle(){
      if(S.gameB_done){ return `<div class="progress">${U().alreadyPuzzle}</div>` + renderNav(); }
      const order=[1,2,3,4], mixed=[...order].sort(()=>Math.random()-0.5); window.__puz__={next:1};
      let g=`<div class="puzzle">`; mixed.forEach(n=> g+=`<div class="piece" data-n="${n}" onclick="clickPiece(this)">${n}</div>`); g+=`</div><div class="puzzle-hint">${U().puzzleHint} <b>1, 2, 3, 4</b></div><div class="navigation"><button class="nav-btn prev" onclick="prevPage()">⬅️ ${U().back}</button><button class="nav-btn next" id="puzNext" disabled>${U().next}</button></div>`; return g;
    }
    function clickPiece(el){
      const s=window.__puz__; const n=+el.dataset.n; if(el.classList.contains('correct')) return;
      if(n===s.next){ el.classList.add('correct'); s.next++; if(s.next>4){ S.gameB_done=true; save(); const b=document.getElementById('puzNext'); b.disabled=false; b.onclick=()=>nextPage(); if(S.autoNarrate && S.voiceOn) speakText(U().puzzleDone); } }
      else { el.style.transform='scale(0.95)'; setTimeout(()=>el.style.transform='',120); }
    }

    /* ======= Pintado principal ======= */
    function loadPage(){
      document.getElementById('title').innerHTML = TEXT[L()].title;
      document.getElementById('subtitle').innerHTML = TEXT[L()].subtitle;

      const d = dataForPage();
      const sc = document.getElementById('story-container');
      let html = `<div class="story-text">${d.text}</div>`;
      if(d.isGame){ html += (d.gameType==='bells'?renderBells():renderPuzzle()); }
      else if(d.isFinal){ html += renderCarol(); }
      else if(d.hasChoice){
        html += `<div class="choices">
          <button class="choice-btn" onclick="choose('A')">🔍 ${U().searchBells}</button>
          <button class="choice-btn" onclick="choose('B')">🎨 ${U().makeBells}</button>
        </div>`;
      } else { html += renderNav(); }
      sc.innerHTML = html;

      document.getElementById('page-counter').textContent = (L()==='en' ? `📖 Page ${S.pg} / 15` : `📖 Página ${S.pg} / 15`);

      const img = document.getElementById('scene-img');
      const fallback = document.getElementById('fallback');
      fallback.innerHTML = fallbackFor(S.pg, S.path);
      img.onerror = ()=>{ /* deja el fallback */ };
      img.onload  = ()=>{ /* imagen cargada, todo ok */ };
      img.src = d.img || '';

      startSnow();

      setTimeout(()=>{ if(S.autoNarrate && S.voiceOn) speakCurrentPage(); }, 120);
    }

    function nextPage(){ stopSpeech(); if(S.pg<15){S.pg++;} else {S.pg=1; S.path=null; S.gameA_done=false; S.gameB_done=false;} save(); loadPage(); }
    function prevPage(){ stopSpeech(); if(S.pg>1){ if(S.pg===8 && S.path) S.path=null; S.pg--; } save(); loadPage(); }
    function choose(p){ S.path=p; S.pg=8; stopSpeech(); save(); loadPage(); }

    /* ======= Voz ======= */
    function voicesByLang(lang){ const vs=window.speechSynthesis.getVoices(); const exact=vs.filter(v=>(v.lang||'').toLowerCase().startsWith(lang.toLowerCase())); const subset=vs.filter(v=>(v.lang||'').toLowerCase().startsWith(lang.slice(0,2).toLowerCase())); return exact.length?exact:(subset.length?subset:vs); }
    function populateVoices(){ const sel=document.getElementById('voice'); if(!sel) return; const keep=sel.value; sel.innerHTML='<option value="">(Automática)</option>'; voicesByLang(S.lang).forEach(v=>{ const o=document.createElement('option'); o.value=v.voiceURI; o.textContent=`${v.name} — ${v.lang}`; sel.appendChild(o); }); sel.value=S.voiceURI||keep||''; }
    function pickVoice(){ const list=voicesByLang(S.lang); if(!list.length) return null; if(S.voiceURI){ const v=list.find(x=>x.voiceURI===S.voiceURI); if(v) return v; } const hintsES=['google español','microsoft','helena','laura','sora','camila','luciana','monica','español','spanish']; const hintsEN=['google us','google uk','microsoft','aria','guy','jenny','en-us','en-gb','english','alex','samantha']; const hints=S.lang.startsWith('en')?hintsEN:hintsES; return list.find(v=>hints.some(h=>(v.name||'').toLowerCase().includes(h))) || list[0]; }
    function speakText(text, tone=S.tone, onEnd){ if(!('speechSynthesis' in window)) return alert(L()==='en'?'Your device does not support speech.':'Tu dispositivo no soporta voz.'); if(!S.voiceOn) return; stopSpeech(); const u=new SpeechSynthesisUtterance(text); const p=TONE[tone]||TONE.narrador; u.lang=S.lang; u.rate=p.rate; u.pitch=p.pitch; u.volume=p.volume; const v=pickVoice(); if(v) u.voice=v; u.onend=()=>onEnd&&onEnd(); u.onerror=()=>onEnd&&onEnd(); window.speechSynthesis.speak(u); }
    function speakCurrentPage(){ const tmp=document.createElement('div'); tmp.innerHTML=dataForPage().text; const txt=tmp.textContent||tmp.innerText||''; const btn=document.getElementById('btnListen'); if(btn){ btn.textContent=U().narrating; btn.disabled=true; } speakText(txt, S.tone, ()=>{ if(btn){ btn.textContent=U().listen; btn.disabled=false; } if(S.autoAdvance && S.pg<15 && !(S.pg===8 && !S.gameA_done && !S.gameB_done)) nextPage(); }); }
    function playCarol(){ speakText(TEXT[L()].carolText, 'villancico'); }
    function stopSpeech(){ if('speechSynthesis' in window && window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); const btn=document.getElementById('btnListen'); if(btn){ btn.textContent=U().listen; btn.disabled=false; } } }

    /* ======= Nieve ======= */
    function startSnow(){
      const c=document.getElementById('snow'); const w=c.width=c.offsetWidth, h=c.height=c.offsetHeight; const ctx=c.getContext('2d');
      const flakes=Array.from({length:80},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*2+1,s:Math.random()*0.6+0.2}));
      cancelAnimationFrame(c.__raf);
      (function draw(){ ctx.clearRect(0,0,w,h); for(const f of flakes){ ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fill(); f.y+=f.s; f.x+=Math.sin(f.y*0.01)*0.2; if(f.y>h) f.y=-5; } c.__raf=requestAnimationFrame(draw); })();
    }

    /* ======= Idioma completo ======= */
    function renderHeader(){ document.getElementById('title').innerHTML = TEXT[L()].title; document.getElementById('subtitle').innerHTML = TEXT[L()].subtitle; document.title = L()==='en' ? "Magic Adventure — Movie" : "Aventura Mágica — Película"; }
    function applyLanguage(){ renderHeader(); renderControls(); loadPage(); }

    /* ======= Init ======= */
    document.addEventListener('DOMContentLoaded', ()=>{
      applyLanguage();
      document.addEventListener('keydown', e=>{
        if(e.key==='ArrowRight') nextPage();
        if(e.key==='ArrowLeft')  prevPage();
        if(e.key.toLowerCase()===' ') speakCurrentPage();
        if(e.key.toLowerCase()==='m'){ S.voiceOn=!S.voiceOn; save(); renderControls(); if(!S.voiceOn) stopSpeech(); }
        if(e.key.toLowerCase()==='n'){ S.autoNarrate=!S.autoNarrate; save(); renderControls(); if(!S.autoNarrate) stopSpeech(); }
        if(e.key.toLowerCase()==='a'){ S.autoAdvance=!S.autoAdvance; save(); renderControls(); }
        if(e.key.toLowerCase()==='e'){ S.lang=S.lang.startsWith('en')?'es-ES':'en-US'; save(); applyLanguage(); }
      });
    });
  </script>
</body>
</html>
